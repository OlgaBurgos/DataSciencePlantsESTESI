---
title: "Valoraci?n del riesgo invasor en la Pen?nsula Ib?rica"
author: "Erola APELLIDO, Olga Burgos, Gianluca Arauz, Ram?n Diaz"
date: "July 10, 2018"
output:
  html_document:
    toc: true
    number_sections: true
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(Encoding="UTF-8")
options(tikzDefaultEngine = "xetex")
```
# ?ndice de contenidos
1. Introducción
1. Preguntas y definiciones iniciales
1. Paquetes necesarios
1. Delimitaci?n del marco clim?tico ib?rico (MCI)
1. An?lisis exploratorio
1. Descarte de variables correlacionadas
1. Reducci?n de dimensi?n por An?lisis de Componentes Principales (PCA)
1. Obtenci?n de datos de otros paises y proyecci?n sobre el MCI
1. Determinaci?n del riergo invasor.
1. Oobtenci?n de datos de especies invasoras mundiales: origen y presencia
1. Biliograf?a

# Especies invasoras - Un problema global
Las especies invasoras suponen una amenaza muy importante para la biodiversidad. De hecho se consideran la segunda mayor amenaza a esta,
después de la perdida de hábitat. Una especie invasora según la ICN, las especies invasoras son:

>“Especie exótica invasora”: especie exótica que se establece en un ecosistema o hábitat natural o seminatural; es un agente de cambio y amenaza la diversidad biológica nativa. (UICN, 2000)


##¿Por que son invasoras?
Hay diversas hipotesis que tratan de entender los motivos por los cuales algunas especies se convierten en invasoras. La hipotesis mayoritaria es que la falta de enemigos naturales en el nuevo habitat donde la invasora llega, le permiten crecer sin control invirtiendo menos en compuestos y estrategias defensivas. Esta es la *Enemy Release Hypothesis*.

Otros autores postulan la regla del 10. De diez especies exoticas que llegan a un nuevo terreno, una se convierte en invasora. Esta hipotesis se basa en el azar y el hecho que algunas comunidades son mas faciles de ser invadidas que otras.

Una tercera corriente de autores postula que hay ciertos rasgos que proporcionan a las especies invasoras mayores posibilidades para serlo. Por ejemplo, grandes inversiones en dispersion de semillas, ciclos de vida cortos o crecimiento clonal son algunos de los rasgos propuestos, como los que definen a un "buen invasor"

En realidad ninguna de estas hipotesis son exluyentes y lo que determina el exito invasor podria ser una combinacion de aspectos de las tres corrientes. Lo que esta claro es que poder disponer de la información de que factores determinan o condicionan si una especie se convierte en invasora o no podria ser muy util para las politicas conservación de la biodiversidad, pues la prevención es la acció mas barata para erradicar una especie invasora.

Por eso nosotros queremos comprobar hasta que punto la similutd con el marco climático de una región, en nuestro caso España, puede favorecer o no a la invasión biológica y de ésta manera deducir en que países o regiones, debido a este solapamiento, se deben implementar unas medidas de prevención mayores. 
# Preguntas y definiciones iniciales {.tabset}

Gian -> Creo que deber?amos escribir una un introducci?n corta (tipo  abstract) para situar un poco el tema del trabajo.


## Preguntas
Si las invasiones son exitosas por en coincidencia del clima, ?qu? especies estar?an bien en la pen?nsula ib?rica y son por tanto potencialmente invasoras?

?Las especies invasoras actuales en la pen?nsula ib?rica cumplen esa hip?tesis de coincidencia del clima?
Si las condiciones clim?ticas en la pen?nsula cambiasen en el contexto del cambio clim?tico, ?el n?mero de especies potencialmente invasoras ser?a mayor, menor o igual? ?El cambio clim?tico podr?a potenciar la amenaza invasora?

Teniendo en cuenta el origen de las especies potencialmente invasoras y los movimientos globales de mercanc?as y personas, ?qu? invasiones son mas probables? ?Con qu? paises deber?amos endurecer las pol?ticas de comercio de especies?

?Por qu? superficie se extender?an las especies potencialmente invasoras en la pen?nsula? ?Cu?nto es su da?o potencial?

Teniendo en cuenta las condiciones clim?ticas en la pen?nsula, ?qu? otros pa?ses de Europa podr?an ser susceptibles a la invasi?n debido a similaridades con el marco clim?tico de Espa?a y Portugal?

## Definiciones
**Marco climatico Ib?rico**: Espacio multidimensional definido por los valores de diferentes variables bioclim?ticas georeferenciados dentro de la Peninsula Ib?rica.

**Variable bioclim?tica**: Variable descriptora ambiental considerada determinante para el crecimiento, desarrollo y reproducci?n de la biosfera.

**Nicho clim?tico**: Espacio multidimensional definido por los valores de diferentes variables bioclim?ticas de los puntos de presencia de una especie.

**Especie potencialmente invasora en la Peninsula Ib?rica**: Especie cuyo nicho clim?tico est? comprendido dentro del MCI.

# Paquetes necesarios {.tabset}
Antes de empezar, instalaremos los paquetes necesarios a lo largo del documento.
```{r results='hide', message=FALSE, warning=FALSE} 
# GIAN -> El " results='hide', message=FALSE, warning=FALSE " sirve para que este chunk no nos escriba el output de cargar la librerias en el HTML. Cosa que no aporta nada y queda feillo en el HTML.
list.of.packages <- c("DataExplorer", "raster", "dismo", "plotly", "fmsb", "factoextra", "MASS")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
```

Una vez disponibles todos los paquetes, podemos cargar las respectivas librer?as.
```{r results='hide', message=FALSE, warning=FALSE} 
library("raster")
library(sp)
library("dismo")
library(readr)
library(ggplot2)
library(plotly)
library(MASS)
require(MASS)
library(fmsb)
library(devtools)
install_github("ggbiplot", "vqv")
library(ggbiplot)
library(factoextra)
library("MASS")
library(readr)
# setwd("C:/Users/Desktop/DataSciencePlantsESTESI") 
```

# Delimitaci?n del MCI {.tabset}
En primer lugar descargaremos los datos de la base de datos globales [WorldClim](http://worldclim.org/). Elegiremos las [19 variables bioclim?ticas](http://worldclim.org/bioclim) con una resoluci?n geogr?fica de 2.5' (minutos de grado). El argumento `var = "bio"` de la funci?n `getData()` reclama dichas variables bioclim?ticas. El portal WorldClim incluye variables clim?ticas teniendo en cuenta un contexto de cambio clim?tico. M?s adelante se pueden testear las diferencias. Las variables referentes a la temperatura estan multiplicadas por 10.

```{r,fig.align='center',out.extra='angle=90'}
worldata <- getData("worldclim",var="bio", res=2.5)

plot (worldata$bio1,
   main = "Mapa de la temperatura media (BIO1) global",
   xlab = "Longitud (?C)",
   ylab = "Latitud (?C)")
```

Los datos de `worldata` se encuentran en formato rasterizado. Ahora debemos seleccionar la extensi?n correspondiente a la Pen?nsula Ib?rica. Pasaremos la ventana de latitudes y longitudes que emarcan la Pen?nsula Ib?rica a la funci?n `extent()`: (-10?W, 4?E) y (36?N, 44?N). Seguidamente, recortaremos la extensi?n `e` sobre los datos `worldata` utilizando la funci?n `crop()`.

```{r,fig.align='center',out.extra='angle=90'}
e <- extent(-10, 4, 36, 44)
s.crop <- crop(worldata, e)

plot (s.crop$bio1,
   main = "Mapa de la temperatura media (BIO1) en la Pen?nsula Ib?rica",
   xlab = "Longitud (?C)",
   ylab = "Latitud (?C)")
```
El archivo `s.crop` tambi?n se encuentra en formato rasterizado. Para trabajar m?s comodamente, construiremos un *dataframe* llamado `marcoclim`, definiendo los nombres de las variables bioclim?ticas:

```{r}
#Es una matriz de 19 variables, nos faltan las coordenadas de cada punto, aunque no son esenciales.

# GIAN -> Creo que no hace falta pasar por as.matrix para obtener marcoclim. Se puede pasar directament s.crop a as.data.frame() y el resultado es el mismo.
#a<-as.matrix(s.crop)
#marcoclim <- as.data.frame(a)

marcoclim <- as.data.frame(s.crop)

# GIAN -> Hago un drop de NANs. Creo que los NANs son los datos correspondientes al mar. As???tenemos un dataframe m???s ligero y bonito.
marcoclim <- na.omit(marcoclim)

BIOs <- paste('BIO', (1:19), sep = '')
names(marcoclim) <- BIOs

#summary(marcoclim)
```

Finalmente, exportamos el *dataframe* `marcoclim` en formato `*.csv`.
```{r}
write.csv(marcoclim, file="Datos/MarcoClim2.5.csv")
```

# An?lisis exploratorio {.tabset}

!!!!!!!!! PARA REEMPRENDER DESDE AQU?, CARGA LOS DATOS !!!!!!!!!!!
```{r}
marcoclim<- read_csv("Datos/MarcoClim2.5.csv", 
    col_types = cols(X1 = col_skip()))

#View(marcoclim)
```

Antes de continuar trabajando, necesitamos hacernos una idea de c?mo son los datos, para ello realizamos un peque?o an?lisis exploratorio y data wrangling
```{r}
library(DataExplorer)
marcoclim <- marcoclim[complete.cases(marcoclim),] # Elimina NA
summary(marcoclim) #resumen de cada variable
plot_str(marcoclim) #estructura de los datos
plot_histogram(marcoclim) 
cor(marcoclim) # Idea de la correlacion de unas variables con otras
plot_correlation(marcoclim) #para visualizar mejor la correlaci?n.
```

Ahora, podemos representar los datos obtenidos, dependiendo de las variables que nos interesa mostrar:

Para generar un gr?fico con temperatura y precipitaci?n

```{r, fig.cap= "Temperatura y Precipitaci?n en la Pen?nsula Ib?rica"}
plot(marcoclim$BIO1~marcoclim$BIO12, pch=19, col="lightblue", xlab="Precipitacion Anual (mm)", ylab="Temperatura anual media (?C x10)") #ploteamos temperatura media anual y precipitacion anual)

```
![Gr?fico](./Plots/ScatterplotMarcoclim.png)

Para generar un gr?fico de densidad:
```{r, fig.cap = "Grafico de densidad de Temperatura y Precipitaci?n en la Pen?nsula Ib?rica"}
str(marcoclim)
plot(marcoclim$BIO12 ~ marcoclim$BIO1, col = "blue")
d <- density(marcoclim$BIO1) # returns the density data 
plot(d)

dens <- kde2d(marcoclim$BIO1, marcoclim$BIO12, n=300, lims = c(0,200,0,1400))
image(dens)
filled.contour(dens,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "Annual Mean Temperature (ºC)",
               ylab= "Annual Precipitation (mm)", main = "Marco Clim?tico Ib?rico")

```
![Gr?fico](./Plots/MarcoClimaticoIberico.png)

# DESCARTAR VARIABLES MUY CORRELACIONADAS (opcional) {.tabset}
Al trabajar con 19 varaibles, algunas producto lineal de otras, estamos trabajando con informaci?n redundante. Podemos basarnos en el criterio VIF (factores de inflaci?n de varianza), un enfoque simple para identificar la colinealidad entre las variables explicativas para descartar algunas y probar el modelo mas adelante con todas las variables y con solo las seleccionadas. 

Esto se describe en : https://www.r-bloggers.com/collinearity-and-stepwise-vif-selection/

Definimos la funci?n de c?lculo y seleccion de variables con el VIF
```{r}
vif_func<-function(in_frame,thresh=10,trace=T,...){
  
  library(fmsb)
  
  if(any(!'data.frame' %in% class(in_frame))) in_frame<-data.frame(in_frame)
  
  #get initial vif value for all comparisons of variables
  vif_init<-NULL
  var_names <- names(in_frame)
  for(val in var_names){
    regressors <- var_names[-which(var_names == val)]
    form <- paste(regressors, collapse = '+')
    form_in <- formula(paste(val, '~', form))
    vif_init<-rbind(vif_init, c(val, VIF(lm(form_in, data = in_frame, ...))))
  }
  vif_max<-max(as.numeric(vif_init[,2]), na.rm = TRUE)
  
  if(vif_max < thresh){
    if(trace==T){ #print output of each iteration
      prmatrix(vif_init,collab=c('var','vif'),rowlab=rep('',nrow(vif_init)),quote=F)
      cat('\n')
      cat(paste('All variables have VIF < ', thresh,', max VIF ',round(vif_max,2), sep=''),'\n\n')
    }
    return(var_names)
  }
  else{
    
    in_dat<-in_frame
    
    #backwards selection of explanatory variables, stops when all VIF values are below 'thresh'
    while(vif_max >= thresh){
      
      vif_vals<-NULL
      var_names <- names(in_dat)
      
      for(val in var_names){
        regressors <- var_names[-which(var_names == val)]
        form <- paste(regressors, collapse = '+')
        form_in <- formula(paste(val, '~', form))
        vif_add<-VIF(lm(form_in, data = in_dat, ...))
        vif_vals<-rbind(vif_vals,c(val,vif_add))
      }
      max_row<-which(vif_vals[,2] == max(as.numeric(vif_vals[,2]), na.rm = TRUE))[1]
      
      vif_max<-as.numeric(vif_vals[max_row,2])
      
      if(vif_max<thresh) break
      
      if(trace==T){ #print output of each iteration
        prmatrix(vif_vals,collab=c('var','vif'),rowlab=rep('',nrow(vif_vals)),quote=F)
        cat('\n')
        cat('removed: ',vif_vals[max_row,1],vif_max,'\n\n')
        flush.console()
      }
      
      in_dat<-in_dat[,!names(in_dat) %in% vif_vals[max_row,1]]
      
    }
    
    return(names(in_dat))
    
  }
  
}
```

Aplicamos la funci?n a los datos
```{r}
vif_func(in_frame=marcoclim,thresh=5,trace=T) # La funcion va calculando los VIF cada vez que quita el que tiene mayor valor hasta quedarnos con valores de VIF por debajo del umbral (hemos puesto 5, pero podria ser otro)
```


# Reducci?n de dimensionalidad mediante PCA {.tabset}
PAra describir de forma reducida el marco clim?tico Ib?rico realizamos una reducci?n de dimensiones por Analisis de Componentes principales:

Cargamos los datos
```{r}
marcoclim<- read_csv("Datos/MarcoClim2.5.csv", 
    col_types = cols(X1 = col_skip()))

#View(marcoclim)
marcoclim <- marcoclim[complete.cases(marcoclim),] # Elimina NA

```

PCA con todos los datos:
```{r}
pcaclim <- prcomp(marcoclim, center = TRUE, scale. = TRUE) 
print(pcaclim)
plot(pcaclim, type = "l")
summary(pcaclim)
plot(pcaclim$x[,1],pcaclim$x[,2], col = "lightblue")
```
![Gr?fico](./Plots/ScatterplotPCA.png)

Se explica un 75,42% de la variabilidad con el componente principal 1 y 2. Nos parece suficiente para continuar. 


PCA solo con las variables que VIF < 5
```{r}
marcoclimVIF <- marcoclim[,c(2,3,8,9,13,15)]

pcaclim2 <- prcomp(marcoclimVIF, center = TRUE, scale. = TRUE) 
print(pcaclim2)
plot(pcaclim2, type = "l")
summary(pcaclim2)
```

Otro plot interesante, es por ejemplo, la contribucion de cada una de las variables en el an?lisis de componentes principales.
```{r}
fviz_pca_var(pcaclim,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
)  ##Funci?n para ver la contribuci?n de cada variable en esta PCA

## Manera de representar la PCA extra?do de https://tgmstat.wordpress.com/2013/11/28/computing-and-visualizing-pca-in-r/

g <- ggbiplot(pcaclim, obs.scale = 1, var.scale = 1, 
               ellipse = TRUE, alpha=0.1, 
              circle = TRUE)
g <- g + scale_color_discrete(name = '')
g <- g + theme(legend.direction = 'horizontal', 
               legend.position = 'top')
print(g)
```
![Gr?fico](./Plots/ContributionPCA.png)

# Obtenci?n de datos de paises y proyecci?n sobre el MCI {.tabset}
Pretendemos evaluar pa?s por pa?s, si sus condiciones clim?ticas se parecen a las de la pen?nsula ib?rica, con el fin de determinar despu?s especies que podr?an encontrar condiciones favorables en nuestro pa?s actuando como invasoras. Por eso proyectamos los datos de marco clim?tico de estos pa?ses sobre el nuestro.

Cargamos los datos del marco climatico ib?rico:
```{r}
marcoclim<- read_csv("Datos/MarcoClim2.5.csv", 
    col_types = cols(X1 = col_skip()))

#View(marcoclim)
marcoclim <- marcoclim[complete.cases(marcoclim),] # Elimina NA

```

Preparamos los datos de la Peninsula Ib?rica de los dos primeros componentes:
```{r}
e <- pcaclim$x[,1:2]
edf <- as.data.frame(e)
edf$pais <- "Spain" #A?adimos una varaible de Pais, con todas las etiquetes "Spain"
head(edf)
```


Descargamos los datos del WordClim (ya hecho previamente en el #3)
```{r}
#Download the WorldClim Data
worldata <- getData("worldclim",var="bio", res=2.5)
plot(worldata$bio1, main =  "Temperatura media anual mundial (?C x10)")
```

En: https://www.gis-blog.com/r-raster-data-acquisition, encontramos como se realiza la descarga y recorte de los paises. Para llamar a un pais concreto se usa la nomenclatura de tres letras definida en: http://kirste.userpage.fu-berlin.de/diverse/doc/ISO_3166.html. Hay una base de datos con los nombres y codigos de los 241 paises que incluye la lista. Podemos importar esos datos:
```{r}
CountryCodes <- read_delim("Datos/CountryCodes.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)

#A3 son los codigos para descargar el pais
```


Descargamos los limites politicos de un pais con la funci?n:
```{r}
denmark <- getData('GADM', country='DNK', level=0)
plot(denmark)
s<- crop(worldata, denmark)
s2 <- mask(s, denmark)
s2<-as.matrix(s2)
marcoclim.denmark <- as.data.frame(s2)
names(marcoclim.denmark) <- c("BIO1","BIO2","BIO3","BIO4", "BIO5", "BIO6", "BIO7", "BIO8", "BIO9",
                 "BIO10","BIO11","BIO12","BIO13", "BIO14", "BIO15", "BIO16", "BIO17", "BIO18", "BIO19")

marcoclim.denmark <- marcoclim.denmark[complete.cases(marcoclim.denmark),]

```
![Gr?fico](./Plots/MapaDinamarca.png)


Proyectamos estos valores sobre el PCA del marco climatico ib?rico. Generamos la variable pais, con el nombre de la etiqueta del mismo. Además combinamos los dos data frames, con los datos de PC1 y PC2 de España y el país seleccionado.
```{r}
i <- predict (pcaclim, newdata = marcoclim.denmark) 
i <- i[,1:2]

idf <- as.data.frame(i) 
idf$pais <- "Din" 

df <- rbind(edf,idf) 

```


Generamos un gr?fico para visualizar el grado de solapamiento de ambas nubes de puntos:

```{r}
ggplot(df, aes(x=PC1, y=PC2, col=pais)) + geom_point()

```
![Gr?fico](./Plots/GgplotContrastePaises.png)

Solapamos dos gr?ficos de densidad para visualizar el grado de solapamiento de ambas nubes de puntos:
```{r}
# PARA HACER UN SOLO GRAFICO DE DENSIDAD CON TODOS LOS DATOS SERIA AS?
dens <- kde2d(df$PC1, df$PC2, n=300, lims = c(-20,10,-10,10))
image(dens)
filled.contour(dens,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "PC1",
               ylab= "PC2", main = "Contraste de marcos climaticos")

# AHORA SOLO ESPAÑA:
dense <- kde2d(edf$PC1, edf$PC2, n=300, lims = c(-12,7,-10,10))
image(dense)
filled.contour(dense,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "PC1",
               ylab= "PC2", main = "Marco clim?tico Ib?rico")

#AHORA SOLO EL PAIS PROYECTADO:
densi <- kde2d(idf$PC1, idf$PC2, n=300, lims = c(-12,7,-10,10))
image(densi)
filled.contour(densi,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "PC1",
               ylab= "PC2", main = "Marco clim?tico Ib?rico del pais proyectado")
#Como se ponen los dos juntos??
```
![Gr?fico](./Plots/PCAMarcoClimIberico.png)
![Gr?fico](./Plots/PCAdensityDinamarca.png)

# Determinaci?n del riesgo invasor {.tabset}
Queremos cuantificar el grado de solapamiento de las nubes de puntos descritas por los puntos de los dos paises, el receptor (Espa?a) y el proyectado.
Hay que crear ciertos metricos para la determinaci?n de el grado de riesgo de invasi?n. 

# Significaci?n por *bootstraping* {.tabset}
Realizar una ANOVA con permutaciones por Bootstraping: contraste de la distribuci?n de etiquetas a l'azar con la distribuci?n real de etiquetas. ?La assignaci?n podria haber sido al azar?
Si el resultado resulta significativo, hay diferenciaci?n del espacio climatico y por lo tanto las especies del pais proyectado no podrian sobrevivir en Espa?a. 

COMO HACERLO EN R??  PENDIENTE

# Significaci?n por Test de Permutaci?n {.tabset}

# Grado de solapamiento desde el receptor y desde el proyectado {.tabset}

PENDIENTE!!!

# Otros? {.tabset}

PENDIENTE!!!

# OBTENCION DATOS DE ESPECIES INVASORAS MUNDIALES. ORIGEN Y PRESENCIA {.tabset}

Turbelin et al. 2017, utilizan datos de http://www.iucngisd.org/gisd/ y de https://www.cabi.org/isc/. para determinar los patrones de distribucion de especies invasoras, en CABI existen datasets de cada una de las especies ex?ticas invasoras. Descargamos estos datos para una lista de plantas, recogen pa?s donde la planta est? presente, latitud longitud, si es nativa o introducida, etc.  Los uniremos entre si? . 

# Bibliograf?a {.tabset}

# Sitios web {.tabset}

https://worldclim.org/bioclim
https://www.cabi.org/isc/.
https://www.r-bloggers.com/collinearity-and-stepwise-vif-selection/
https://tgmstat.wordpress.com/2013/11/28/computing-and-visualizing-pca-in-r/
https://www.gis-blog.com/r-raster-data-acquisition http://kirste.userpage.fu-berlin.de/diverse/doc/ISO_3166.html.
https://stackoverflow.com/questions/31272695/calculate-probability-of-point-on-2d-density-surface
https://rstudio-pubs-static.s3.amazonaws.com/330387_5a40ca72c3b14824acedceb7d34618d1.html

https://stats.stackexchange.com/questions/63447/integrating-kernel-density-estimator-in-2d

# Art?culos y libros {.tabset}

Turbelin, Anna J., Malamud, Bruce D., Francis, Robert A.Mapping the global state of invasive alien species: patterns of invasion and policy responses.*Global Ecology & Biogeography*, September 2016.

Davison, A. C. & Hinkley, D. V. (1997) Bootstrap Methods and Their Applications. Cambridge University Press, Cambridge. ISBN 0-521-57391-2