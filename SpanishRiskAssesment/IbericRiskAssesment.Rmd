---
title: "Valoración del riesgo invasor en la Península Ibérica en base a la similitud climática"
author: "Erola Fenollosa, Olga Burgos, Gianluca Arauz, Ramon Diaz"
date: "July, 2018"
output:
  html_document:
    toc: true
    number_sections: true
  pdf_document: default
  word_document: default
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(Encoding="UTF-8")
options(tikzDefaultEngine = "xetex")
library(knitr)
hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  lines <- options$output.lines
  if (is.null(lines)) {
    return(hook_output(x, options))  # pass to default hook
  }
  x <- unlist(strsplit(x, "\n"))
  more <- "..."
  if (length(lines)==1) {        # first n lines
    if (length(x) > lines) {
      # truncate the output, but add ....
      x <- c(head(x, lines), more)
    }
  } else {
    x <- c(more, x[lines], more)
  }
  # paste these lines together
  x <- paste(c(x, ""), collapse = "\n")
  hook_output(x, options)
})
```

# Especies invasoras - Un problema global {.tabset}
El crecimiento poblacional y la industrialización han llevado al hombre a ocupar prácticamente todos los biomas, impactando gravemente en la diversidad de los sistemas naturales. La biodiversidad es esencial para el mantenimiento de las funciones y servicios ecosistémicos, de los cuales nos beneficiamos, pero a la vez son indispensables para el mantenimiento de la homeóstasis terrestre (@Cardinale2012). Los esfuerzos para la conservación de estas funciones han llevado a analizar las causas de pérdida de la biodiversidad, siendo las especies invasoras la segunda mayor amenaza a la biodiversidad, después de la pérdida de hábitat (@SIMBERLOFF2013). Para luchar contra esta causa necesitamos políticas de gestión efectivas, pero el esfuerzo de erradicación aumenta con el tiempo de invasión, y por este motivo es imprescindible tratar de trabajar en la previsión y primeras fases de invasión (@VanWilgen2014).

Según la Unión Internacional para la Conservación de la naturaleza (UICN), las especies invasoras son:

>“Especie exótica invasora”: especie exótica que se establece en un ecosistema o hábitat natural o seminatural; es un agente de cambio y amenaza la diversidad biológica nativa (UICN, 2000).

##¿Por qué son invasoras?
Existen diversas hipótesis que tratan de explicar los motivos por los cuales algunas especies se convierten en invasoras. La hipótesis mayoritaria es que la falta de enemigos naturales en el nuevo hábitat dónde la invasora llega, le permite crecer sin control invirtiendo menos en compuestos y estrategias defensivas. Esta es la *Enemy Release Hypothesis* (@Catford200922).

Otros autores postulan la regla del 10. De diez especies exóticas que llegan a un nuevo terreno, una se convierte en invasora. Esta hipótesis se basa en el azar y el hecho de que algunas comunidades son mas fáciles de ser invadidas que otras (@Richardson2006409).

Una tercera corriente postula que hay ciertos rasgos que proporcionan a las especies invasoras mayores posibilidades para serlo. Por ejemplo, grandes inversiones en dispersión de semillas, ciclos de vida cortos o crecimiento clonal son algunos de los rasgos propuestos para definir un "buen invasor" (@VanKleunen2010947).

Ninguna de estas hipótesis es excluyente, por lo que los factores determinantes del éxito invasor podría ser una combinación de aspectos de las tres corrientes (@Catford200922). 

Pese a la divergencia de hipótesis que explican la expansión de las especies invasoras, encontramos una mayor unificación con respecto a las teorías que explican el establecimiento de las especies fuera de su rango nativo. No todas las especies pueden ser encontradas en todos los hábitats. Cada especie tiene sus requerimientos y por lo tanto es posible definir su nicho ecológico en base a las condiciones donde una especie puede vivir, crecer y reproducirse (@Grinnell1917). El nicho de una especie se define como una región (un hipervolumen de n dimensiones) en un espacio multidimensional basado en factores ambientales que afectan al bienestar de la especie (Hutchinson 1957). La similitud climática entre diferentes países podría ser clave para entender el establecimiento de las especies fuera de su rango nativo y una herramienta muy útil para la valoración del riesgo invasor. Un mejor conocimiento de los factores que determinan si una especie podría convertirse en invasora, sería vital para las políticas de conservación de la biodiversidad, pues la prevención es la acción más económica para erradicar una especie invasora (@Kumschick20131095). Saber hasta qué punto la similitud con el marco climático de una región, en nuestro caso la Península Íbérica, puede favorecer a la invasión biológica nos puede permitir definir medidas de prevención mayores.


# Objetivos del trabajo y definiciones iniciales {.tabset}

## Objetivos

El objetivo principal de este trabajo es utilizar diferentes herramientas de gestión y análisis de datos para valorar el riesgo invasor en la Península Ibérica, en base a la hipótesis de la similitud climática como principal factor determinante para el establecimiento de espécies exóticas. Los objetivos específicos son:

- Definir el marco climático delimitado por el espacio geográfico de la Península Ibérica.
- Cuantificar el grado de similitud climática de todos los países del mundo con el clima de la Península Ibérica.
- Determinar si los países con mayor similitud climática son tambien fuente de mayores espécies invasoras en España.


## Definiciones
>**Marco climatico Ibérico**: Espacio multidimensional definido por los valores de diferentes variables bioclimáticas georreferenciados dentro de la Península Ibérica.

>**Variable bioclimática**: Variable descriptora ambiental considerada determinante para el crecimiento, desarrollo y reproducción de la biosfera.

>**Nicho climático**: Espacio multidimensional definido por los valores de diferentes variables bioclimáticas de los puntos de presencia de una especie.


# Paquetes necesarios {.tabset}
La versión de R con la que se ha trabajado es:
```{r}
Rv <- R.Version()
Rv$version.string
```

Antes de empezar, instalaremos los paquetes necesarios a lo largo del documento.
```{r echo=TRUE, results='hide', message=FALSE, warning=FALSE} 
list.of.packages <- c("DataExplorer", "raster", "dismo", "plotly", "fmsb", "factoextra", "MASS","hypervolume","alphahull", "dplyr", "rgdal", "leaflet", "RColorBrewer", "devtools")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
```

Una vez disponibles todos los paquetes, podemos cargar las respectivas librerías.
```{r echo=2:17, results='hide', message=FALSE, warning=FALSE}
# setwd("C:/Users/Desktop/DataSciencePlantsESTESI") 
library(raster)
library(sp)
library(dismo)
library(ggplot2)
library(plotly)
library(MASS)
require(MASS)
library(fmsb)
library(devtools)
install_github("ggbiplot","vqv")
library(ggbiplot)
library(factoextra)
library(readr)
library(hypervolume)
library(alphahull)
library(DataExplorer)
library(dplyr)
library(rgdal)
library(leaflet)
library(RColorBrewer)
library(readxl)
```

# Delimitación del MCI {.tabset}
En primer lugar descargaremos el *dataset* de la base de datos globales [WorldClim](http://worldclim.org/) que ofrece [19 variables bioclimáticas](http://worldclim.org/bioclim) con una resolución geográfica de 10' (minutos de grado) ya que resoluciones mayores conllevan demasiado esfuerzo computacional. El argumento `var = "bio"` de la función `getData()` reclama dichas variables bioclimáticas. Las variables referentes a la temperatura están multiplicadas por 10.

```{r,fig.align='center',out.extra='angle=90'}
worldata <- getData("worldclim",var="bio", res=10)
worldata_25 <- getData("worldclim",var="bio", res=2.5)

plot (worldata_25$bio1,
   main = "Mapa de la temperatura media (BIO1) global",
   xlab = "Longitud (ºC)",
   ylab = "Latitud (ºC)")
```

Los datos de `worldata` se encuentran en formato rasterizado. Ahora debemos seleccionar la extensión correspondiente a la Península Ibérica. Pasaremos la ventana de latitudes y longitudes que enmarcan la Península Ibérica a la función `extent()`: (-10º W, 4ºE) y (36ºN, 44ºN). Seguidamente, recortaremos la extensión `e` sobre los datos `worldata` utilizando la función `crop()`.

```{r, fig.align='center', out.extra='angle=90'}
e <- extent(-10, 4, 36, 44)
s.crop <- crop(worldata_25, e)

plot (s.crop$bio1,
   main = "Mapa de la temperatura media (BIO1) en la Península Ibérica",
   xlab = "Longitud (ºC)",
   ylab = "Latitud (ºC)")
```
El archivo `s.crop` también se encuentra en formato rasterizado. Para trabajar más cómodamente, construiremos un *dataframe* llamado `marcoclim`, definiendo los nombres de las variables bioclimáticas:

```{r}

marcoclim <- as.data.frame(s.crop)

BIOs <- paste('BIO', (1:19), sep = '')
names(marcoclim) <- BIOs

```

Finalmente, exportamos el *dataframe* `marcoclim` en formato `*.csv`.
```{r}
write.csv(marcoclim, file="Datos/MarcoClim2.5.csv")
```

# Análisis exploratorio {.tabset}
Para no perder tiempo descargando cada vez los datos del marcoclim y preparándolos, cargamos directamente el csv generado:
```{r warning=FALSE}
marcoclim<- read_csv("Datos/MarcoClim2.5.csv", 
    col_types = cols(X1 = col_skip()))
```

Antes de continuar trabajando, necesitamos hacernos una idea de cómo son los datos, para ello realizamos un pequeño análisis exploratorio y *data wrangling*.

## *Data wrangling*

En la mayoría de ocasiones los datos con los que se trabaja necesitan de una limpieza y una preparación previa para ser analizados. 
En nuestro caso, eliminamos los missing values del marcoclim.

```{r fig.align='center'}
marcoclim <- marcoclim[complete.cases(marcoclim),] # Elimina NA's.
marcoclim <- na.omit(marcoclim)
head(marcoclim)
```

## Estructura de los datos

```{r fig.align='center'}
summary(marcoclim) #resumen de cada variable
plot_str(marcoclim) #estructura de los datos
plot_histogram(marcoclim) 
```

## Correlación entre variables

```{r output.lines=20, fig.align='center', warning=FALSE}
cor(marcoclim) # Idea de la correlación de unas variables con otras.
plot_correlation(marcoclim) #para visualizar mejor la correlación
```

## Visualización de la exploración

Ahora, podemos representar los datos obtenidos, dependiendo de las variables que nos interesa mostrar:

Para generar un gráfico con temperatura y precipitación:

```{r fig.align='center'}
plot(marcoclim$BIO1~marcoclim$BIO12, pch=19, col="blue", xlab="Precipitación Anual (mm)", ylab="Temperatura anual media (ºC x10)",main="Temperatura y Precipitación en la Península Ibérica")
```

Podemos graficar las variables teniendo en cuenta su densidad estimada en base a métodos como *Kernel Density Estimation*. La estimación de la función de densidad para la temperatura media anual seria: 

```{r fig.align='center'}
d <- density(marcoclim$BIO1) # devuelve los datos de densidad 
plot(d)
```

Para generar un gráfico de densidad con dos variables usamos la función `kde2d`(kernel density two dimensions) del paquete `MASS`, usando las variables de temperatura media anual y precimitación media anual:

```{r fig.align='center'}
dens <- kde2d(marcoclim$BIO1, marcoclim$BIO12, n=300, lims = c(0,200,0,1400))
image(dens)
filled.contour(dens,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "Annual Mean Temperature (ºC)",
               ylab= "Annual Precipitation (mm)", main = "Marco Climático Ibérico")
```

# Descartar variables muy correlacionadas (opcional) {.tabset}
Al trabajar con 19 variables, algunas producto lineal de otras como hemos visto en el gráfico de correlación, estamos trabajando con información redundante. Podemos basarnos en el criterio `VIF` (factores de inflación de varianza), un enfoque simple para identificar la colinealidad entre las variables explicativas para descartar algunas y probar el modelo más adelante con todas las variables y con solo las seleccionadas. 

La cuantificación de los factores de inflación de la varianza y el descarte paso a paso se pueden realizar con una función descrita en el blog [beckmw](https://beckmw.wordpress.com/2013/02/05/collinearity-and-stepwise-vif-selection/):

```{r warning=FALSE}
vif_func<-function(in_frame,thresh=10,trace=T,...){
  
  library(fmsb)
  
  if(any(!'data.frame' %in% class(in_frame))) in_frame<-data.frame(in_frame)
  
  #get initial vif value for all comparisons of variables
  vif_init<-NULL
  var_names <- names(in_frame)
  for(val in var_names){
    regressors <- var_names[-which(var_names == val)]
    form <- paste(regressors, collapse = '+')
    form_in <- formula(paste(val, '~', form))
    vif_init<-rbind(vif_init, c(val, VIF(lm(form_in, data = in_frame, ...))))
  }
  vif_max<-max(as.numeric(vif_init[,2]), na.rm = TRUE)
  
  if(vif_max < thresh){
    if(trace==T){ #print output of each iteration
      prmatrix(vif_init,collab=c('var','vif'),rowlab=rep('',nrow(vif_init)),quote=F)
      cat('\n')
      cat(paste('All variables have VIF < ', thresh,', max VIF ',round(vif_max,2), sep=''),'\n\n')
    }
    return(var_names)
  }
  else{
    
    in_dat<-in_frame
    
    #backwards selection of explanatory variables, stops when all VIF values are below 'thresh'
    while(vif_max >= thresh){
      
      vif_vals<-NULL
      var_names <- names(in_dat)
      
      for(val in var_names){
        regressors <- var_names[-which(var_names == val)]
        form <- paste(regressors, collapse = '+')
        form_in <- formula(paste(val, '~', form))
        vif_add<-VIF(lm(form_in, data = in_dat, ...))
        vif_vals<-rbind(vif_vals,c(val,vif_add))
      }
      max_row<-which(vif_vals[,2] == max(as.numeric(vif_vals[,2]), na.rm = TRUE))[1]
      
      vif_max<-as.numeric(vif_vals[max_row,2])
      
      if(vif_max<thresh) break
      
      if(trace==T){ #print output of each iteration
        prmatrix(vif_vals,collab=c('var','vif'),rowlab=rep('',nrow(vif_vals)),quote=F)
        cat('\n')
        cat('removed: ',vif_vals[max_row,1],vif_max,'\n\n')
        flush.console()
      }
      
      in_dat<-in_dat[,!names(in_dat) %in% vif_vals[max_row,1]]
      
    }
    
    return(names(in_dat))
    
  }
  
}
```

Aplicamos la función a nuestros datos. Ésta va calculando los `VIF`, y en cada cálculo quita el que tiene mayor valor hasta quedarse con valores de VIF por debajo del umbral definido (en nuestro caso hasta quedarnos con  valores inferiores a 5, un umbral recomendado).

```{r, warning=FALSE, output.lines=22}
vif_func(in_frame=marcoclim,thresh=5,trace=T) 
```
Estas son las variables con las que nos quedariamos para reducir la colinealidad. 



# Reducción de dimensionalidad mediante PCA {.tabset}
Para describir de forma reducida el MCI realizamos una reducción de dimensiones mediante *análisis de componentes principales*.

## PCA con todas las variables

Realizamos la PCA con nuestros datos utilizando la función `prcomp` que R tiene incorporada.
```{r output.lines=27}
pcaclim <- prcomp(marcoclim, center = TRUE, scale. = TRUE) 
print(pcaclim)
```

```{r fig.align='center'}
plot(pcaclim, type = "l")
summary(pcaclim)
```

Obtenemos la desviación estándar y la proporción de la varianza de cada una de los componentes principales basándose en las 19 variables climáticas. Con PC1 y PC2 se explica un **75,44%** de la variabilidad. Teniendo en cuenta el objetivo del trabajo, consideramos adecuado quedarnos con los dos primeros componentes.

Además, podemos calcular el peso de cada variable bioclimática para cada componente principal, con `pca$rotation`
```{r}
pcaclim$rotation[,1] # PC1
pcaclim$rotation[,2] # PC2
```

Para facilitar el entendimiento de la contribución de cada una de las variables en el análisis de componentes principales, Podemos generar plots con las funciones:
-`fviz_pca_var`
-`ggbiplot`


```{r fig.align='center'}
fviz_pca_var(pcaclim,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
)  

g <- ggbiplot(pcaclim, obs.scale = 1, var.scale = 1, 
               ellipse = TRUE, alpha=0.02, circle = FALSE)
print(g)
```

## PCA con la función 'VIF'
También podríamos realizar una `PCA` solo con las variables que `VIF` < 5(opcional)
```{r fig.align='center'}
marcoclimVIF <- marcoclim[,c(2,3,8,9,13,15)]

pcaclim2 <- prcomp(marcoclimVIF, center = TRUE, scale. = TRUE) 
print(pcaclim2)
plot(pcaclim2, type = "l")
summary(pcaclim2)
```

Como podemos comprobar, usando el criterio `VIF` la variabilidad explicada en el PCA con dos componentes resulta del 58.05%, un porcentaje inferior que cuando no eliminamos las variables redundantes, por tanto decidimos no trabajar siguiendo este criterio. 

# Obtención de datos de países y proyección sobre el MCI {.tabset}
Llegados a este punto, pretendemos evaluar si las condiciones climáticas de los diferentes países del mundo se parecen a las de la Península Ibérica. Así se podrá determinar después qué especies podrían encontrar condiciones favorables en nuestro país actuando como invasoras y qué especies españolas podrían serlo para otros países. Con estas evidencias se controlarían mejor la entrada y salida de especies invasoras, mejorando las políticas de comercio y transporte por ejemplo. Por eso proyectamos los datos del marco climático de estos países sobre el nuestro.


Cargamos los datos del Marco Climático Ibérico:
```{r warning=FALSE}
marcoclim<- read_csv("Datos/MarcoClim2.5.csv", 
    col_types = cols(X1 = col_skip()))

marcoclim <- marcoclim[complete.cases(marcoclim),] # Elimina NA's
```

Preparamos los datos de la Península Ibérica de los dos primeros componentes:
```{r}
e <- pcaclim$x[,1:2]
edf <- as.data.frame(e)
edf$pais <- "PenIberica" #Añadimos una varaible de País, con todas las etiquetes "PenIberica"
head(edf)
```


Descargamos los datos del WordClim (ya hecho previamente)
```{r fig.align='center'}
#Download the WorldClim Data
worldata <- getData("worldclim",var="bio", res=2.5)
```

En este [blog](https://www.gis-blog.com/r-raster-data-acquisition), encontramos como se realiza la descarga y recorte de los países. Para llamar a un país concreto se usa la nomenclatura de tres letras definida [aquí](http://kirste.userpage.fu-berlin.de/diverse/doc/ISO_3166.html). Hay una base de datos con los nombres y codigos de los 241 países que incluye la lista. Podemos importar esos datos:
```{r results=FALSE}
CountryCodes <- read_delim("CountryCodes.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)
#A3 son los codigos para descargar el país.
```


Descargamos los límites políticos de un país, por ejemplo Dinamarca, de la siguiente forma:

```{r fig.align='center'}
denmark <- getData('GADM', country='DNK', level=0)
s<- crop(worldata_25, denmark)
s2 <- mask(s, denmark)
s2<-as.matrix(s2)
marcoclim.denmark <- as.data.frame(s2)
names(marcoclim.denmark) <- BIOs
marcoclim.denmark <- marcoclim.denmark[complete.cases(marcoclim.denmark),]
plot (s$bio1,
   main = "Mapa de la temperatura media (BIO1) en Dinamarca",
   xlab = "Longitud (ºC)",
   ylab = "Latitud (ºC)")
```
Así, obtenemos un `dataframe` con las variables bioclimáticas de este país.

Proyectamos estos valores sobre el `PCA` del marco climático ibérico. Generamos la variable país, con el nombre de la etiqueta del mismo. Además combinamos los dos data frames, con los datos de PC1 y PC2 de España y el país seleccionado.
```{r}
i <- predict (pcaclim, newdata = marcoclim.denmark) 
i <- i[,1:2]

idf <- as.data.frame(i) 
idf$pais <- "Dinamarca" 

df <- rbind(edf,idf) 
```


Generamos un gráfico para visualizar el grado de solapamiento de ambas nubes de puntos usando la función 
`ggplot`

```{r fig.align='center'}
p<-ggplot(df, aes(x=PC1, y=PC2, col=pais)) + geom_point() + ggtitle("Proyección de Dinamarca sobre el PCA del Marco Climático Ibérico")
p + labs(x = "PC1 (46.3%)", y = "PC2 (29.1%)" )
```

Para entender mejor el solapamiento podemos generar gráficos de densidad:

Para el Marco Climático Ibérico:
```{r fig.align='center'}
dense <- kde2d(edf$PC1, edf$PC2, n=300, lims = c(-12,7,-10,10))
image(dense)
filled.contour(dense,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "PC1",
               ylab= "PC2", main = "Marco climático Ibérico")
```

Para Dinamarca:
```{r fig.align='center'}
densi <- kde2d(idf$PC1, idf$PC2, n=300, lims = c(-12,7,-10,10))
image(densi)
filled.contour(densi,
               color.palette=colorRampPalette(c('gray94','blue','yellow','red','darkred')),
               xlab= "PC1",
               ylab= "PC2", main = "Marco climático Ibérico del país proyectado")
```

Pero, ¿Cómo podemos cuantificar el grado de solapamiento, teniendo en cuenta la densidad de los datos?

# Cuantificación del grado de similitud climática {.tabset}
##Coincidencia climática versus MCI 
Con el fin de determinar el grado de solapamiento climático de un país cualquiera respecto al MCI, creamos hipervolúmenes a partir de los dos primeros componentes principales, que explican un 75.44% de la varianza, y los comparamos, obteniendo así el volumen compartido y otros índices de similitud.

Para ello, utilizaremos el paquete `hypervolume` (@Blonder2017)(@BlonderB2017), un paquete diseñado para estimar la forma y volumen de bases de datos de más de una dimension y realizar operaciones con ellos: intersección, unión, determinación de los componentes únicos, tests de inclusión y detección de agujeros. Usa una aproximación basada en geometria estocástica ([CRAN] (https://cran.r-project.org/web/packages/hypervolume/hypervolume.pdf)).

Con el objetivo de determinar valores de solapamiento del MCI con todos los países del mundo, crearemos un bucle para contrastar país a país. En primer lugar definiremos el hipervolumen definido por los puntos en el PCA del MCI, a lo que denominaremos marco estático. El marco dinámico estará constituido por aquellos elementos en bucle, dinámicos, de los cuales iremos sacando un conjunto de *outputs*. En las diferentes pestañas definiremos estos elementos.

##Definiendo el marco climático estático
Una vez obtenidos los datos del MCI, realizado el análisis de componentes principales y creado un data frame con los resultados de éste, definiremos el primer hipervolumen. El hipervolumen de n-dimensiones es una medida que generaliza el concepto de volumen a espacios de dimensión. En nuestro caso utilizaremos un `Gaussian KDE`(*kernel density estimation*) en el que todos los puntos contribuyen a la densidad de la probabilidad global ya que testeando vemos que es el mejor algoritmo de inclusion de puntos por nuestra tipologia de distribuciones. 

En la función `hypervolume_gaussian`, por defecto, se le asigna un umbral del 95%, asegurando la máxima probabilidad en la estimación de la densidad.
Además generaremos un plot para visualizar el hipervolumen en el que se genera un centroide (en rojo al centro del volumen).

```{r fig.align='center'}
hv1sp = hypervolume_gaussian(data=subset(df,pais=="PenIberica")[1:41573, 1:2])
plot(hv1sp,show.contour=TRUE,contour.kde.level=0.01)

```

## Definiendo el marco climático dinámico
El siguiente paso será generar un hipervolumen para cada uno de los países que testearemos frente al MCI. Por ejemplo, creamos un hipervolúmen con los datos de Dinamarca.

```{r fig.align='center'}
hv2dn = hypervolume_gaussian(data=subset(df,pais=="Dinamarca")[1:3571, 1:2])
plot(hv2dn,show.contour=TRUE,contour.kde.level=0.01)
```

## *Outputs*
Una vez obtenidos los dos hipervolúmenes, utilizaremos la función `hypervolume_set` y `hypervolume_overlap_statistics`.
La primera genera valores estadísticos computando la intersección, la unión y los componentes únicos(diferencia) de los hipervolúmenes, que podemos observar llamando la función `get_volume`

La segunda función calcula los métricos de superposición para los dos hipervolúmenes. Imprime directamente los índices de similitud entre los dos volúmenes:

>**Similitud de Jaccard**: Volumen de la intersección de un país respeto al otro, dividido por el volumen de la unión de estos países.

>**Similitud de Sorensen**: Dos veces el volumen de la interesección de un país sobre el otro, dividido por la suma del volumen de ambos países.

> **Fracción Única 1**: Volumen del componente único del primer país dividido por el volumen total de éste.

> **Fracción única 2**: Volumen del componente único del segundo país dividido por el volumen total de éste.

Además calcularemos la distancia entre centroides usando la función `hypervolume_distance`

```{r}
setH <-hypervolume_set(hv1sp, hv2dn, check.memory = FALSE)
volumes<-get_volume(setH)
overl<- hypervolume_overlap_statistics(setH)

dist<- hypervolume_distance(hv1sp, hv2dn, type='centroid')
```

Con los datos estadísticos obtenidos anteriormente, podemos generar una lista para facilitar la visualización de los diferentes índices y volúmenes.

```{r fig.align='center'}
values <- c(volumes, overl, dist)
```

En esta figura ilustramos los diferentes índices obtenidos:
<center>
![Métricos de contraste de similitud](./Plots/EsquemaResultados.png)


## Bucle para la cuantificación sistemática de los hipervolúmenes
En este punto, implementaremos un sencillo *for loop* para testear la similitud del marco climático de cada país respecto al de la Península Ibérica de forma rápida y sistemática. El MCI será un valor fijo en este bucle, mientras que los *inputs* seran los datos climáticos de los diferentes países a testear. A partir de este bucle, generaremos como *output* un *DataFrame* que recogerá los volúmenes e índices respecto al MCI de la mayoría de países del mundo. Primero cargaremos una lista con los nombres y los acrónimos de todos los países del mundo:

```{r}
CountryCodes <- read.csv("CountryCodes.csv", header=FALSE, sep=";", skip = 1)
```

Decimos "mayoría" de países porque los datos climáticos de algunos de ellos no presentan una distribución geográfica suficientemente amplia como para ser procesados correctamente por la función `hypervolume_gaussian` del paquete `hypervolume`. Para evitar que el bucle se interrumpa, debemos eliminar manualmente dichos países:

```{r}
black_list = list('ASM', 'AIA', 'ATA', 'ABW', 'BMU', 'BVT', 'IOT', 'CYM', 'CXR', 'CCK', 'GIB', 'GRD', 'KIR', 'LIE', 'MAC', 'MDV', 'MLT', 'MHL', 'FSM', 'MCO', 'MSR', 'NRU', 'ANT', 'NIU', 'NFK', 'MNP', 'PCN', 'RUS', 'SHN', 'KNA', 'LCA', 'SPM', 'VCT', 'SMR', 'SCG', 'SYC', 'TKL', 'TUV', 'UMI', 'VAT', 'VGB', 'WLF')
CountryCodesSum <- CountryCodes[ ! CountryCodes$V3 %in% black_list, ]
```

Como puede verse, la mayoría de los países de la lista `black_list` son muy pequeños, como por ejemplo SMR (San Marino), GIB (Gibraltar) o VAT (Ciudad del Vaticano). También aparecen muchos estados insulares, como es el caso de CYM (Islas Caimán), BMU (Bermudas) o SYC (Seychelles). ATA (Antártida) aparece en esta lista, no por tener una superficie pequeña (que no es el caso), sino por la escasa distribución geogràfica de sus datos climáticos.

Un caso aparte es el de RUS (Rusia), que ha sido colocada en la `black_list` debido a la extremadamente amplia distrubución geográfica de sus datos climáticos (debido a su gran extensión). Los ordenadores con los que hemos trabajado no disponían de memoria suficiente como para cargar los datos generados por la función `hypervolume_gaussian` aplicada a Rusia.

A continuación mostraremos el código del blucle que hemos implementado. Es importante aclarar que el siguiente bloque de código ha sido configurado para no ser ejecutado mediante la opción `eval = FALSE`:

```{r eval = FALSE, echo = FALSE}
my_df <- data.frame()
counter=1

for(ID_cntry in CountryCodesSum$V3) {
  print(ID_cntry)

countrybound <- getData('GADM', country=ID_cntry, level=0) #Entra el código del país
s<- crop(worldata, countrybound)
s2 <- mask(s, countrybound)
marcoclim.country <- as.data.frame(s2)

names(marcoclim.country) <- BIOs

marcoclim.country <- marcoclim.country[complete.cases(marcoclim.country),]
i <- predict (pcaclim, newdata = marcoclim.country) 
i <- i[,1:2]
idf <- as.data.frame(i)
ID_label <- paste("Spain vs.", ID_cntry, sep=' ')
idf$pais <- ID_label
df <- rbind(edf,idf)
hv2dn = hypervolume_gaussian(data = subset(df,pais == ID_label)[1:nrow(idf), 1:2]) 
setH <-hypervolume_set(hv1sp, hv2dn, check.memory = FALSE) 
volumes<-get_volume(setH)
overl<- hypervolume_overlap_statistics(setH)
dist<- hypervolume_distance(hv1sp, hv2dn, type='centroid')
values <- c(volumes, overl, dist)
my_df <- rbind(my_df, values)
my_df[counter, "Country"] <- ID_cntry
counter <- counter + 1
print(my_df)
}
rm(counter)
write.csv(my_df, file = "Volumes.csv")
```

El bucle recorre todos los países en un lapso de unas 7 horas aproximadamente. Esto trabajando con una *workstation* de la siguientes caracteríticas:

* Memoria RAM: 64 GB.
* Disco duro SSD: 256 GB.
* Procesador: Processador: Intel Core i7-7700 @ 3.6 GHz de 4 núcleos.

Como ya hemos avanzado, el *output* de nuestro bucle es un *DataFrame* llamado `Volumes` que incluye todos los índices y volúmenes proporcionados por la función `hypervolume_gaussian`. Finalmete, editaremos brevemente el *DataFrame* `Volumes` con la intención de llegar a un *DataFrame* un poco más leíble y *friendly*.

```{r}
CountryCodes$V2 <- NULL
CountryCodes$V4 <- NULL
Volumes <- read.csv("Volumes.csv", header = T)
Volumes$X <- NULL
Vol.Names <- c('Vol.MCI', 'Vol.Country', 'Vol.Intersection', 'Vol.Union', 'Vol.Unique.MCI', 'Vol.Unique.Country', 'Jaccart', 'Sorensen', 'NormVol.MCI', 'NormVol.Country', 'Dist.Centroid', 'Country.Acronym')
names(Volumes) <- Vol.Names
rownames(Volumes) <- Volumes$Country.Acronym
names(CountryCodes) = c('Country.Name', 'V3')
Volume_dataset <- merge(Volumes, CountryCodes, by.x = "Country.Acronym", by.y = "V3")
write.csv(Volume_dataset, file = "Volumes_dataset.csv")
```

# Determinación del riesgo invasor  {.tabset}
## El *top ten* de países de mayor riesgo
Los diferentes índices y valores obtenidos anteriormente nos permiten ordenar los países de forma que podamos visualizar aquellos que presentan un mayor grado de similitud climática. 

Cada índice nos revela características distintas de la intersección entre los volúmenes. Vamos a explorar los resultados obtenidos considerando el *top ten* de países por cada índice. 

```{r}

Volumes_dataset <- read.csv("Volumes_dataset.csv")

rVolCount <- arrange(Volumes_dataset, desc(Vol.Country)) # Ordenado de mayor volumen a menor
rVolCount <- rVolCount$Country.Acronym # Guardamos la columna con los nombres de los países

rintersection <- arrange(Volumes_dataset, desc(Vol.Intersection)) #Ordenado de mayor interesección a menor
rintersection <- rintersection$Country.Acronym

rvoluniqmci <- arrange(Volumes_dataset, Vol.Unique.MCI) # Ordenado de menor a mayor volumen único en la Península Iberica.
rvoluniqmci <- rvoluniqmci$Country.Acronym

rvoluniqcount <- arrange(Volumes_dataset, Vol.Unique.Country) # Ordenado de menor a mayor volumen único en la Península Ibérica.
rvoluniqcount <- rvoluniqcount$Country.Acronym

rjaccard <- arrange(Volumes_dataset, desc(Jaccart)) # Ordenado de mayor a menor grado de similitud de Jacacard
rjaccard <- rjaccard$Country.Acronym

rsorensen <- arrange(Volumes_dataset, desc(Sorensen)) # Ordenado de mayor a menor grado de similitud de Sorensen
rsorensen <- rsorensen$Country.Acronym

rnormvolmci <- arrange(Volumes_dataset, NormVol.MCI) # Ordenado de menor a mayor fracción única de MCI
rnormvolmci <- rnormvolmci$Country.Acronym

rnormvolcount <- arrange(Volumes_dataset, NormVol.Country) # Ordenado de menor a mayor fracción única del país contrastado
rnormvolcount <- rnormvolcount$Country.Acronym

rdistance <- arrange(Volumes_dataset, Dist.Centroid) # Ordenado de menor a mayor distancia entre centroides
rdistance <- rdistance$Country.Acronym

ranking <- data.frame(rVolCount, rintersection, rvoluniqmci, rvoluniqcount, rjaccard, rsorensen, rnormvolmci, rnormvolcount, rdistance)

names(ranking) <- c('Vol.Country', 'Vol.Intersection', 'Vol.Unique.MCI', 'Vol.Unique.Country', 'Jaccard', 'Sorensen', 'NormVol.MCI', 'NormVol.Country', 'Dist.Centroid')

topten <- ranking[1:10,] #Sacamos los 10 primeros países.
print(topten)

```



## Mapa de riesgo mundial
La mejor forma de presentar los valores obtenidos de similitud entre países es diseñar un mapa mundial con diferentes colores para aquellas zonas con mayor similitud climática con la Península Ibérica, y por lo tanto mayor riesgo invasor.

Para ello, usaremos el paquete `leaflet`, que nos permite la creación de mapas interactivos. En primer lugar descargamos los datos de fronteras y polígonos de todos los países del mundo desde el portal Web de [Thematicmapping](http://thematicmapping.org/downloads/world_borders.php).

Necesitaremos también el paquete `rgdal`, para obtener csv con los datos descargados, con la función `readOGR`. Los datos deben estar en un repositorio real del ordenador para cargarlos, por ejemplo así:

```{r eval = FALSE, echo = TRUE}
#world_spdf=readOGR(dsn= "getwd() ",layer="TM_WORLD_BORDERS_SIMPL-0.3")
world_spdf=readOGR(dsn= "C:/WorldBorders",layer="TM_WORLD_BORDERS_SIMPL-0.3")

```


Combinamos los datos de los polígonos con la variable que queremos visualizar:

*ÍNDICE DE JACCARD*:
```{r eval = FALSE, echo = TRUE}
world_spdf@data$number<-c(1:246)

dfJac <- Volumes[,c(7,12)]
names(dfJac) <- c("Jaccard", "ISO3")

world_spdf@data<-merge(world_spdf@data, dfJac, by= "ISO3", all.x= TRUE)
world_spdf@data<-arrange(world_spdf@data, number)
world_spdf@data$Jaccard[ which(world_spdf@data$Jaccard == 0)] = NA

pal <- colorQuantile("YlOrRd", NULL, n = 9)

state_popup <- paste0("<strong> País: </strong>", 
                      world_spdf$NAME, 
                      "<br><strong>Indice de Jaccard: </strong>", 
                      world_spdf$Jaccard)

leaflet(data = world_spdf) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(fillColor = ~pal(Jaccard), 
              fillOpacity = 0.8, 
              color = "#BDBDC3", 
              weight = 1, 
              popup = state_popup) %>%
  addLegend(pal= pal, values= ~Jaccard, opacity=0.9, title = "Jaccard (%)", position = "bottomleft" )
```

El resultado de éste codigo genera un gráfico interactivo que permite visualizar con zoom los valores del índice en los diferentes países. 
Aquí mostramos una imagen PNG del mismo, pero para acceder al gráfico interactivo seguir [este enlace](Jaccard.html). Los valores NA corresponden a una similitud nula.

*Grado de similitud climatica respecto la Península Ibérica*
<center>
![Similtud climática en base al índice de Jaccard](./Plots/JaccardPNG.png)


## Origen de las actuales especies invasoras en España
La Ley 42/2007, de 13 de diciembre, del Patrimonio Natural y de la Biodiversidad creó, en su artículo 61.1, el Catálogo Español de Especies Exóticas Invasoras en el que se incluyen todas aquellas especies exóticas invasoras que constituyan, de hecho, o puedan llegar a constituir una amenaza grave para las especies autóctonas, los hábitats o los ecosistemas, la agronomía, o para los recursos económicos asociados al uso del patrimonio natural ([Ministerio de Agricultura , Pesca y Alimentación](https://www.mapama.gob.es/es/biodiversidad/temas/conservacion-de-especies/especies-exoticas-invasoras/)).

El Catálogo Español de Especies Exóticas Invasoras contempla 181 especies de diferentes grupos taxonómicos provinientes de diferentes países. 

Con el objetivo de comprobar si aquellos países con mayor coincidencia climática son fuente de más especies actualmente invasoras, se ha realizado una búsqueda en los portales de [ISSG](http://issg.org/database/species/List.asp) y [GBIF](https://www.gbif.org/) para definir los países de origen de las actuales invasoras. 

El resultado de esta búsqueda es el siguiente *data frame*:

```{r}
origeninvasoras <- read_excel("Datos/origeninvasoras.xlsx")
```

Recontamos el numero de ocurrencias de cada país y lo mezclamos con 
los datos de similitud:
```{r}
countriesorigen <-origeninvasoras[,7:56]
b<-as.matrix(countriesorigen)
a<-as.vector(b)
a.t<-table(a)
a.df <- as.data.frame(a.t)
df <- mutate_all(a.df, funs(toupper))
names(df) <- c("Country.Name", "NumSpecies")
withsp<-merge(df, Volume_dataset, by="Country.Name", all.y = TRUE)
withsp$NumSpecies <- as.integer(withsp$NumSpecies)

```

Seleccionamos el *top ten* de países que han aportado mayor número de especies invasoras:


```{r}
ttorigin <- arrange(withsp, desc(NumSpecies))
ttorigin <- data.frame(ttorigin$Country.Acronym, ttorigin$NumSpecies)
ttorigin[1:10,] #Sacamos los 10 primeros países.

```


Podemos representar en forma de correlación los resultados obtenidos, para determinar si la mayor similitud climática explica el número de especies invasoras que aporta ese país:

*Distáncia entre centroides vs. Número de especies invasoras aportadas*
```{r}
withsp <- withsp[complete.cases(withsp),] 

p <- ggplot(withsp, aes(x=NumSpecies, y=Dist.Centroid)) +
  geom_point() +
  geom_smooth(method =lm, se=FALSE )
p + labs(x = "Número de especies invasoras en España del país considerado", y = "Distáncia entre centroides climáticos" )

```


*Valor de Índice de Jaccard vs. Número de especies invasoras aportadas*
```{r}
p <-ggplot(withsp, aes(x=NumSpecies, y=Jaccart)) +
  geom_point() +
  geom_smooth(method =lm, se=FALSE)
p + labs(x = "Número de especies invasoras en España del país considerado", y = "Índice de Jaccard" )

```



## Refinando el riesgo invasor en base a otras variables
A parte de la similitud del marco climático, hay otros factores que pueden resultar determinantes para la determinación del riesgo invasor. La cantidad de mercancías y personas que se desplazan de un país a otro, podrían ser clave para entender en que medida realmente podrían ocurrir los desplazamientos de especies exóticas. Además, en los resultados presentados en el apartado anterior, hay una variabilidad muy grande, probablemente por trabajar con datos de especies invasoras de diferentes grupos taxonómicos. 
Todo esto requiere la obtención de nuevos datos y desarrollo de nuevos modelos. De forma exploratoria presentaremos algunos modelos simples explorando datos disponibles como son la biodiversidad de cada país (que implicaría mayor probabilidad de existir una espécie que pueda ser invasora) y la distáncia entre el país y la Península Ibérica (lo que probablemente facilite también la llegada de especies alóctonas).

*BIODIVERSIDAD*:
Existen datos de biodiversidad de especies normalizados por el tamaño del país: el [*National Biodiversity Index*](https://www.cbd.int/gbo1/annex.shtml). Los valores estan normalizados entre 1 (Màximo: Indonesia) y 0 (Mínimo: Groenlándia).

Importamos los datos 
```{r}
CountryData <- read_excel("Datos/CountryDataSum.xlsx")

names(CountryData)[3] <- "Country.Acronym"
complete<- merge(Volume_dataset, CountryData, by = "Country.Acronym")
complete <-merge(withsp, complete, by="Country.Acronym")

```

Generamos el gráfico:
```{r}
complete$nbi <- as.numeric(complete$NBI)

p <- ggplot(complete, aes(x=NumSpecies, y=nbi)) +
  geom_point() +
geom_smooth(method = loess, se= TRUE)
p + labs(x = "Número de especies invasoras en España del país considerado", y = "Índice de Biodiversidad nacional" )
```

Los 10 países con mayor valor de biodiversidad son:
```{r}
nbirank <- arrange(complete, desc(nbi))
nbirank <- data.frame(nbirank$Country.Acronym, nbirank$nbi)
nbirank[1:10,] #Sacamos los 10 primeros países.

```


*DISTÁNCIA GEOGRÁFICA*:
A través del portal Web [Geodatos](https://www.geodatos.net) hemos podido obtener los valores de distancia geográfica de todos los países respecto la Península Ibérica.

```{r}
complete$distance.km <- as.numeric(complete$distance.km)

p <- ggplot(complete, aes(x=NumSpecies, y=distance.km)) +
  geom_point() +
geom_smooth(method = lm, se= FALSE)
p + labs(x = "Número de especies invasoras en España del país considerado", y = "Distáncia respecto el país de origen (km)" )
```



# Conclusiones
Durante el desarrollo de este trabajo, hemos aprendido a utilizar distintas herramientas computacionales para valorar el grado de similitud climática de la Península Ibérica con el resto del mundo, con el objetivo de estimar el riesgo invasor. 
Distintos paquetes de `R`y algunas bases de datos disponibles *on-line*, referentes a variables bioclimáticas de las distintas regiones del planeta, nos han permitido desarrollar un estudio que consideramos muy útil para determinar riesgo invasor, y que sienta las bases de posibles proyectos futuros de evaluación de este tipo.
Estos resultados, ayudarían al entendimiento de la problemática relacionada con la pérdida de hábitat y diversidad y podrían mejorar políticas de gestión que protejan o controlen la entrada y salida de especies con potencial invasor, protegiendo así la biodiversidad de nuestro país y también del resto. 

Fijándonos en el *ranking* que hemos obtenido, podemos encontrar los países con más riesgo respecto a la Península Ibérica, dependiendo del métrico o índice al que atendamos. En nuestro caso, hemos determinado el índice de Jaccard y Sorensen como los más representativos de la similitud de volumenes para la selección de estos países con condiciones más similares y por tanto de riesgo.
Como podemos apreciar en los últimos mapas, lo países ordenados de mayor a menor riesgo para la Península Ibérica son:

1. Argentina
2. Grecia
3. Sur África
4. Italia
5. Líbano
6. Portugal
7. Albania
8. Turquía
9. Australia.

El resultado de este ranking tiene sentido pues todos los países listados, contienen clima mediterráneo, o bien comparten cercanía con España, o latitud geográfica. 

Algunos de estos países también constan en el ranquing de países.... 
- NUM SPECIES
- BIODIVER
- PROXIMIDAD




Finalmente, nos gustaría resaltar las múltiples posibilidades en cuanto a las variables que se podrían tener en cuenta para seguir evaluando el riesgo, teniendo en cuenta lo desarrollado y obtenido en este trabajo.Por ejemplo, testeo del riesgo invasor de especies animales o plantas a nivel individual, o la determinación del riesgo en base al movimiento de ciudadanos o mercancía entre países, o en base a la cercanía en kilómetros de los territorios.



# Bibliografía
